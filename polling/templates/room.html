<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Color Prediction Game - Room {{ room_name }}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///wAAAAA=">

    <!-- Load the enhanced CSS framework -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    <!-- Simple Design Overrides -->
    <link rel="stylesheet" href="{% static 'css/simple-overrides.css' %}">

    <style>
        /* Game Room Specific Styles */
        body {
            background: var(--background-primary);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4);
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .game-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .room-info-card {
            background: var(--background-primary);
            border-radius: var(--border-radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .timer-display {
            font-size: var(--text-4xl);
            font-weight: var(--font-black);
            color: var(--error-color);
            text-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .balance-display {
            font-size: var(--text-xl);
            color: var(--success-color);
            font-weight: var(--font-bold);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .player-count-display {
            font-size: var(--text-xl);
            color: var(--primary-color);
            font-weight: var(--font-bold);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .game-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        .betting-card {
            background: var(--background-primary);
            border-radius: var(--border-radius-lg);
            padding: var(--space-6);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .betting-header {
            margin-bottom: var(--space-6);
        }

        .betting-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .bet-status-info {
            background: var(--info-50);
            border: 1px solid var(--info-200);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            animation: fadeIn 0.3s ease;
        }

        .bet-status-message {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            color: var(--info-700);
            font-weight: var(--font-medium);
        }

        .status-icon {
            font-size: var(--text-base);
        }

        .colors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        /* Simplified Color Box Styles */
        .color-box {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
            border-radius: var(--border-radius-lg);
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: var(--font-bold);
            color: white;
            text-shadow: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            user-select: none;
        }

        .color-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .color-box:active {
            transform: translateY(0);
        }

        .color-box.selected {
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }

        .color-box.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .color-box-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
        }

        .color-box-label {
            font-weight: var(--font-bold);
            font-size: var(--text-base);
        }

        .color-box-multiplier {
            font-size: var(--text-sm);
            opacity: 0.9;
        }

        .color-box-bet-count {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
        }

        /* Override fancy styles from main.css */
        .color-box::before,
        .color-box::after {
            display: none !important;
        }

        .color-box {
            background: var(--game-red) !important;
            box-shadow: none !important;
            transform: none !important;
        }

        .color-box[data-color="red"] {
            background: var(--game-red) !important;
        }

        .color-box[data-color="green"] {
            background: var(--game-green) !important;
        }

        .color-box[data-color="violet"] {
            background: var(--game-violet) !important;
        }

        .color-box:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }

        .color-box:active {
            transform: translateY(0) !important;
        }

        .color-box.selected {
            transform: none !important;
            border: 2px solid white !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5) !important;
        }

        .bet-controls {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            align-items: stretch;
        }

        .bet-amount-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .bet-amount-label {
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .bet-amount-input {
            display: flex;
            gap: var(--space-3);
            align-items: center;
        }

        .bet-input {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: var(--text-base);
            font-weight: var(--font-medium);
            text-align: center;
            transition: border-color 0.2s ease;
        }

        .bet-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .players-card {
            background: var(--background-primary);
            border-radius: var(--border-radius-lg);
            padding: var(--space-6);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .players-header {
            margin-bottom: var(--space-4);
        }

        .players-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .players-list {
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .players-list::-webkit-scrollbar {
            width: 6px;
        }

        .players-list::-webkit-scrollbar-track {
            background: var(--background-secondary);
            border-radius: var(--border-radius-full);
        }

        .players-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--border-radius-full);
        }

        .player-item {
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            background: var(--background-secondary);
            border-radius: var(--border-radius-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition-smooth);
            border: 1px solid var(--border-color);
        }

        .player-item:hover {
            background: var(--background-tertiary);
            transform: translateY(-1px);
        }

        .player-name {
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .player-bet {
            font-weight: var(--font-bold);
            color: var(--primary-color);
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .player-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-1);
        }

        .bet-amount {
            font-weight: var(--font-bold);
            color: var(--success-color);
            font-size: var(--text-sm);
        }

        .no-bets-message, .loading-message {
            text-align: center;
            padding: var(--space-6);
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Recent Bets Styles */
        .bet-item {
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            background: var(--background-secondary);
            border-radius: var(--border-radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .bet-item:hover {
            background: var(--background-tertiary);
        }

        .bet-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
            flex: 1;
        }

        .bet-round {
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .bet-details {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .bet-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-1);
        }

        .bet-result {
            font-size: var(--text-xs);
            padding: 2px 6px;
            border-radius: var(--border-radius-sm);
            font-weight: var(--font-medium);
            text-transform: uppercase;
        }

        .bet-result.win {
            background: #dcfce7;
            color: #166534;
        }

        .bet-result.loss {
            background: #fef2f2;
            color: #dc2626;
        }

        .bet-result.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .color-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .color-dot.red {
            background: #ef4444;
        }

        .color-dot.green {
            background: #22c55e;
        }

        .color-dot.violet {
            background: #8b5cf6;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: var(--text-xs);
            border: 1px solid var(--border-color);
            background: var(--background-primary);
            color: var(--text-secondary);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .btn-sm:hover {
            background: var(--background-secondary);
            color: var(--text-primary);
        }

        .btn-secondary {
            background: var(--background-secondary);
        }

        /* Simplified button styles */
        .btn {
            background: var(--primary-color) !important;
            border-radius: var(--border-radius-md) !important;
            box-shadow: none !important;
            transform: none !important;
        }

        .btn:hover {
            background: var(--primary-hover) !important;
            transform: none !important;
        }

        .btn:active {
            transform: none !important;
        }

        .messages-card {
            background: var(--background-primary);
            border-radius: var(--border-radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            margin-top: var(--space-6);
        }

        .messages-container {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .message {
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            border-radius: var(--border-radius-lg);
            background: var(--background-secondary);
            border-left: 4px solid var(--border-color);
            transition: var(--transition-smooth);
        }

        .message.bet {
            background: var(--info-50);
            border-left-color: var(--info-500);
            color: var(--info-700);
        }

        .message.result {
            background: var(--success-50);
            border-left-color: var(--success-500);
            color: var(--success-700);
        }

        .message.error {
            background: var(--error-50);
            border-left-color: var(--error-500);
            color: var(--error-700);
        }
        .result-display {
            text-align: center;
            padding: var(--space-6);
            margin: var(--space-6) 0;
            border-radius: var(--border-radius-lg);
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent;
        }

        .result-display.win {
            background: var(--success-50);
            color: var(--success-700);
            border-color: var(--success-200);
        }

        .result-display.lose {
            background: var(--error-50);
            color: var(--error-700);
            border-color: var(--error-200);
        }

        .hidden { display: none; }

        .phase-indicator {
            text-align: center;
            padding: var(--space-3);
            margin-bottom: var(--space-6);
            border-radius: var(--border-radius-md);
            font-weight: var(--font-bold);
            font-size: var(--text-sm);
            text-transform: uppercase;
        }

        .phase-betting {
            background: var(--info-100);
            color: var(--info-700);
            border: 1px solid var(--info-200);
        }

        .phase-result {
            background: var(--warning-100);
            color: var(--warning-700);
            border: 1px solid var(--warning-200);
        }

        /* Simple Loading for result phase */
        .result-loading {
            text-align: center;
            padding: var(--space-6);
            margin: var(--space-6) 0;
            border-radius: var(--border-radius-lg);
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
        }

        .result-skeleton {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--text-muted);
        }

        /* Deposit Reminder */
        .deposit-reminder {
            background: var(--warning-50);
            border: 1px solid var(--warning-300);
            border-radius: var(--border-radius-lg);
            padding: var(--space-6);
            margin: var(--space-4) 0;
            text-align: center;
            display: none;
        }

        .deposit-reminder.show {
            display: block;
            animation: depositPulse 3s infinite;
        }

        .deposit-reminder h4 {
            color: var(--warning-700);
            margin: 0 0 var(--space-2) 0;
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
        }

        .deposit-reminder p {
            color: var(--warning-600);
            margin: var(--space-1) 0;
            font-size: var(--text-sm);
        }

        @keyframes depositPulse {
            0% { box-shadow: var(--shadow-lg); }
            50% { box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); }
            100% { box-shadow: var(--shadow-lg); }
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                padding: var(--space-4) var(--space-2);
            }

            .game-container {
                margin: 0;
            }

            .room-info-card {
                flex-direction: column;
                text-align: center;
                gap: var(--space-3);
            }

            .timer-display {
                font-size: var(--text-3xl);
            }

            .balance-display,
            .player-count-display {
                font-size: var(--text-lg);
            }

            .game-layout {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }

            .colors-grid {
                grid-template-columns: 1fr 1fr;
                gap: var(--space-3);
            }

            .bet-controls {
                gap: var(--space-3);
            }
        }

        @media (max-width: 480px) {
            .colors-grid {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .timer-display {
                font-size: var(--text-2xl);
            }
        }

    </style>
</head>
<body>
    <div class="game-container">
        <!-- Game Header -->
        <div class="game-header">
            <h1>üéÆ Color Prediction Game</h1>
            <h2>Room: {{ room_name }}</h2>
        </div>

        <!-- Room Info Card -->
        <div class="room-info-card">
            <div class="timer-display">
                ‚è∞ <span id="timer">--</span>
            </div>
            <div class="balance-display">
                üí∞ Balance: ‚Çπ<span id="balance">{{ user_balance }}</span>
            </div>
            <div class="player-count-display">
                üë• Players: <span id="player-count">0</span>
            </div>
        </div>

        <!-- Phase Indicator -->
        <div id="phase-indicator" class="phase-indicator phase-betting">
            üéØ Betting Phase - Place Your Bets!
        </div>

        <!-- Deposit Reminder -->
        <div id="deposit-reminder" class="deposit-reminder">
            <h4>üí∞ Add Money to Your Wallet</h4>
            <p>You need to add money to your wallet before placing bets.</p>
            <p>Minimum deposit: ‚Çπ10</p>
        </div>

        <!-- Main Game Layout -->
        <div class="game-layout">
            <!-- Betting Section -->
            <div class="betting-card">
                <div class="betting-header">
                    <h3 class="betting-title">Place Your Bet</h3>

                    <!-- Bet Status Info -->
                    <div id="bet-status-info" class="bet-status-info hidden">
                        <div class="bet-status-message">
                            <span class="status-icon">‚ÑπÔ∏è</span>
                            <span class="status-text">You can only place one bet per round</span>
                        </div>
                    </div>
                </div>

                <!-- Color Selection Grid -->
                <div class="colors-grid">
                    <div class="color-box" data-color="red" style="background-color: var(--game-red);">
                        <div class="color-box-content">
                            <div class="color-box-label">RED</div>
                            <div class="color-box-multiplier">2.5x</div>
                        </div>
                        <div class="color-box-bet-count" id="red-count">0</div>
                    </div>
                    <div class="color-box" data-color="green" style="background-color: var(--game-green);">
                        <div class="color-box-content">
                            <div class="color-box-label">GREEN</div>
                            <div class="color-box-multiplier">2.5x</div>
                        </div>
                        <div class="color-box-bet-count" id="green-count">0</div>
                    </div>
                    <div class="color-box" data-color="violet" style="background-color: var(--game-violet);">
                        <div class="color-box-content">
                            <div class="color-box-label">VIOLET</div>
                            <div class="color-box-multiplier">2.5x</div>
                        </div>
                        <div class="color-box-bet-count" id="violet-count">0</div>
                    </div>
                </div>

                <!-- Bet Controls -->
                <div class="bet-controls">
                    <div class="bet-amount-section">
                        <label class="bet-amount-label">Bet Amount (‚Çπ)</label>
                        <div class="bet-amount-input">
                            <input type="number" id="bet-amount" class="bet-input" value="10" min="1" max="1000">
                            <button id="place-bet-btn" class="btn btn-primary" disabled>Place Bet</button>
                        </div>
                    </div>
                </div>

                <!-- Result Display -->
                <div class="result-display hidden" id="result-display"></div>
                <div class="result-loading hidden" id="result-loading">
                    <div class="result-skeleton">üé≤ Calculating Result...</div>
                </div>
            </div>

            <!-- Recent Bets Section -->
            <div class="players-card">
                <div class="players-header">
                    <h3 class="players-title">My Recent Bets</h3>
                    <button id="refresh-bets-btn" class="btn-sm btn-secondary" onclick="loadRecentBets()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="players-list" id="recent-bets-list">
                    <!-- Recent bets will be populated by JavaScript -->
                    <div class="loading-message">Loading recent bets...</div>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div class="messages-card">
            <h3>Game Messages</h3>
            <div class="messages-container" id="messages-container">
                <!-- Messages will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Load the enhanced JavaScript framework -->
    <script src="{% static 'js/main.js' %}"></script>
    <script>
        // Get username from authenticated user
        let username = '{{ current_user.username }}';

        // Wait for DOM to be ready before initializing
        document.addEventListener('DOMContentLoaded', function() {
            if (!username) {
                console.error('User not authenticated');
                window.location.href = '/login/';
            } else {
                // Initialize the game only if user is authenticated
                initializeGame();
            }
        });

        // Global WebSocket manager to prevent memory leaks
        let gameWebSocket = null;

        function initializeGame() {
            // Clean up existing connection
            if (gameWebSocket) {
                gameWebSocket.destroy();
            }

            // Create optimized WebSocket connection
            const roomName = "{{ room_name }}";

            gameWebSocket = window.createGameWebSocket ?
                window.createGameWebSocket(roomName, {
                    open: handleWebSocketOpen,
                    message: handleWebSocketMessage,
                    close: handleWebSocketClose,
                    error: handleWebSocketError
                }) :
                createFallbackWebSocket(roomName);

            // Game state
            let selectedColor = null;
            let gameState = {
                timeRemaining: 0,
                balance: 0,
                bettingClosed: false,
                currentPhase: 'betting',
                currentRound: null
            };

            // DOM elements
            const timerEl = document.getElementById('timer');
            const balanceEl = document.getElementById('balance');
            const playerCountEl = document.getElementById('player-count');
            const phaseIndicatorEl = document.getElementById('phase-indicator');
            const colorBoxes = document.querySelectorAll('.color-box');
            const betAmountInput = document.getElementById('bet-amount');
            const placeBetBtn = document.getElementById('place-bet-btn');
            const resultDisplayEl = document.getElementById('result-display');
            const resultLoadingEl = document.getElementById('result-loading');
            const recentBetsListEl = document.getElementById('recent-bets-list');
            const messagesEl = document.getElementById('messages-container');

            // Timer stuck detection variables
            let lastTimerUpdate = Date.now();
            let lastTimerValue = null;

            // Optimized WebSocket event handlers
            function handleWebSocketOpen(e) {
                console.log('WebSocket connected successfully');
                addMessage('Connected to game server', 'success');
                clearRecentBets();

                // Request current game state
                gameWebSocket.send({ type: 'get_game_state' });
            }

            function handleWebSocketMessage(e) {
                const data = JSON.parse(e.data);
                processWebSocketMessage(data);
                lastTimerUpdate = Date.now();
                updateConnectionHealth(true);
            }

            function handleWebSocketClose(e) {
                console.log('WebSocket closed:', e.code);
                updateConnectionHealth(false);

                if (e.code === 4001) {
                    addMessage('Authentication failed. Redirecting...', 'error');
                    setTimeout(() => window.location.href = '/login/', 2000);
                }
            }

            function handleWebSocketError(e) {
                console.error('WebSocket error:', e);
                addMessage('Connection error occurred', 'error');
            }

            // Fallback WebSocket for older browsers
            function createFallbackWebSocket(roomName) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(protocol + '//' + window.location.host + '/ws/game/' + roomName + '/');

                ws.onopen = handleWebSocketOpen;
                ws.onmessage = handleWebSocketMessage;
                ws.onclose = handleWebSocketClose;
                ws.onerror = handleWebSocketError;

                return {
                    send: (data) => ws.send(typeof data === 'string' ? data : JSON.stringify(data)),
                    destroy: () => ws.close()
                };
            }



            // Connection health monitoring
            let connectionHealthIndicator = null;
            function updateConnectionHealth(isHealthy) {
                if (!connectionHealthIndicator) {
                    connectionHealthIndicator = document.createElement('div');
                    connectionHealthIndicator.id = 'connection-health';
                    connectionHealthIndicator.style.cssText = `
                        position: fixed; top: 10px; right: 10px; z-index: 1000;
                        padding: 5px 10px; border-radius: 5px; font-size: 12px;
                        transition: all 0.3s ease;
                    `;
                    document.body.appendChild(connectionHealthIndicator);
                }

                if (isHealthy) {
                    connectionHealthIndicator.textContent = 'üü¢ Connected';
                    connectionHealthIndicator.style.backgroundColor = '#d4edda';
                    connectionHealthIndicator.style.color = '#155724';
                } else {
                    connectionHealthIndicator.textContent = 'üî¥ Disconnected';
                    connectionHealthIndicator.style.backgroundColor = '#f8d7da';
                    connectionHealthIndicator.style.color = '#721c24';
                }
            }



            // Process WebSocket messages
            function processWebSocketMessage(data) {
                switch(data.type) {
                    case 'game_state':
                        updateGameState(data);
                        break;
                    case 'timer_update':
                        updateTimer(data);
                        break;
                    case 'bet_placed':
                        console.log('Received bet_placed event:', data);
                        handleBetPlaced(data);
                        break;
                    case 'betting_closed':
                        handleBettingClosed();
                        break;
                    case 'round_ended':
                        handleRoundEnded(data);
                        break;
                    case 'new_round_started':
                        console.log('New round started:', data);
                        // Immediately update game state to prevent stale phase information
                        gameState.currentPhase = 'betting';
                        gameState.bettingClosed = false;
                        gameState.hasPlacedBet = false;
                        gameState.timeRemaining = data.time_remaining || 40;
                        if (data.round_id) {
                            gameState.currentRound = data.round_id;
                        }
                        handleNewRound();
                        break;
                    case 'player_joined':
                    case 'player_left':
                        updatePlayerCount(data.player_count);
                        break;
                    case 'error':
                        handleError(data.message);
                        break;
                    case 'heartbeat':
                        // Handle server heartbeat for timer sync
                        if (data.phase === 'betting' && Math.abs(gameState.timeRemaining - data.time_remaining) > 1) {
                            console.log('Timer sync correction applied');
                            updateTimer(data);
                        }
                        break;
                }
            }

            // Game functions
            function updateGameState(data) {
                gameState.timeRemaining = data.time_remaining;
                gameState.balance = data.player_balance;
                gameState.bettingClosed = data.betting_closed;
                gameState.currentRound = data.round_id;

                console.log('Game state updated, round_id:', data.round_id);

                // Update balance display with zero balance warning
                balanceEl.textContent = data.player_balance;
                if (data.player_balance <= 0) {
                    balanceEl.style.color = '#ff4444';
                    balanceEl.title = 'You need to deposit money to place bets';

                    // Show deposit reminder banner
                    document.getElementById('deposit-reminder').classList.add('show');
                } else {
                    balanceEl.style.color = '#4CAF50';
                    balanceEl.title = '';

                    // Hide deposit reminder banner
                    document.getElementById('deposit-reminder').classList.remove('show');
                }

                playerCountEl.textContent = data.players_count;

                // Handle existing bet recovery on reconnection
                if (data.existing_bet) {
                    console.log('Recovering existing bet:', data.existing_bet);

                    // Restore selected color
                    selectedColor = data.existing_bet.color;

                    // Update UI to show the bet was already placed
                    colorBoxes.forEach(box => {
                        box.classList.remove('selected');
                        if (box.dataset.color === selectedColor) {
                            box.classList.add('selected');
                        }
                    });

                    // Update bet amount input
                    betAmountInput.value = data.existing_bet.amount;

                    // Update place bet button to show bet was placed
                    placeBetBtn.disabled = true;
                    placeBetBtn.textContent = `Bet Placed: ‚Çπ${data.existing_bet.amount} on ${selectedColor.toUpperCase()}`;
                    placeBetBtn.style.backgroundColor = '#28a745';

                    // Show notification about recovered bet
                    showNotification(`Bet recovered: ‚Çπ${data.existing_bet.amount} on ${selectedColor.toUpperCase()}`, 'info');
                }

                // Handle existing bets for color counts
                if (data.existing_bets && data.existing_bets.length > 0) {
                    console.log('Loading existing bets:', data.existing_bets);

                    // Reset color bet counts
                    ['red', 'green', 'violet'].forEach(color => {
                        const countElement = document.getElementById(`${color}-count`);
                        if (countElement) {
                            countElement.textContent = '0';
                        }
                    });

                    // Update color bet counts from existing bets
                    data.existing_bets.forEach(bet => {
                        updateColorBetCount(bet.color, 1);
                    });
                }

                // Load recent bets for the current user
                loadRecentBets();

                updateTimer({time_remaining: data.time_remaining, phase: data.betting_closed ? 'result' : 'betting'});
            }

            function updateTimer(data) {
                gameState.currentPhase = data.phase;
                gameState.timeRemaining = data.time_remaining;

                // Update round_id if provided in timer update
                if (data.round_id) {
                    gameState.currentRound = data.round_id;
                }

                if (data.phase === 'result' || gameState.bettingClosed || data.time_remaining <= 0) {
                    // Hide timer and show loading skeleton during result phase
                    timerEl.style.display = 'none';
                    resultLoadingEl.classList.remove('hidden');
                    placeBetBtn.disabled = true;
                    placeBetBtn.textContent = 'Betting Closed';

                    // Ensure betting interface is disabled
                    colorBoxes.forEach(box => {
                        if (!box.classList.contains('selected')) {
                            box.style.opacity = '0.5';
                            box.style.cursor = 'not-allowed';
                        }
                    });
                } else {
                    // Show timer during betting phase
                    timerEl.style.display = 'block';
                    resultLoadingEl.classList.add('hidden');

                    // Ensure timer doesn't get stuck at 1
                    const timeToShow = Math.max(0, data.time_remaining);
                    const minutes = Math.floor(timeToShow / 60);
                    const seconds = timeToShow % 60;
                    timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    // Reset betting state if this is a new round (high time remaining)
                    if (data.phase === 'betting' && data.time_remaining > 35) {
                        gameState.bettingClosed = false;
                        gameState.hasPlacedBet = false;
                        if (placeBetBtn.textContent === 'Betting Closed') {
                            placeBetBtn.disabled = false;
                            placeBetBtn.textContent = 'Place Bet';
                        }
                    }

                    // Re-enable betting interface if not already bet placed and betting is open
                    if (!placeBetBtn.textContent.includes('Placed') && !gameState.bettingClosed) {
                        placeBetBtn.disabled = false;
                        colorBoxes.forEach(box => {
                            box.style.opacity = '1';
                            box.style.cursor = 'pointer';
                        });
                    }
                }

                updatePhaseIndicator(data.phase);
            }

            function updatePhaseIndicator(phase) {
                phaseIndicatorEl.className = `phase-indicator phase-${phase}`;
                phaseIndicatorEl.textContent = phase === 'betting' ? 'BETTING PHASE' : 'RESULT PHASE';
                phaseIndicatorEl.classList.remove('hidden');
            }

            function handleBetPlaced(data) {
                if (data.username === username) {
                    gameState.balance = data.player_balance;
                    balanceEl.textContent = data.player_balance;
                    placeBetBtn.disabled = true;
                    placeBetBtn.textContent = 'Bet Placed ‚úì';

                    // Show bet status info
                    const betStatusInfo = document.getElementById('bet-status-info');
                    const statusText = betStatusInfo.querySelector('.status-text');
                    const statusIcon = betStatusInfo.querySelector('.status-icon');

                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = `Your bet: ‚Çπ${data.amount} on ${data.color.toUpperCase()}`;
                    betStatusInfo.classList.remove('hidden');

                    // Disable color selection
                    colorBoxes.forEach(box => {
                        box.style.opacity = '0.5';
                        box.style.cursor = 'not-allowed';
                    });
                }

                // Update color bet counts
                updateColorBetCount(data.color, 1);

                // If this is the current user's bet, refresh recent bets
                if (data.username === username) {
                    loadRecentBets();
                }

                addMessage(`${data.username} bet ‚Çπ${data.amount} on ${data.color}`, 'bet');
            }

            // Load recent bets for the current user
            async function loadRecentBets() {
                try {
                    recentBetsListEl.innerHTML = '<div class="loading-message">Loading recent bets...</div>';

                    const response = await fetch('/api/my-recent-bets/', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        displayRecentBets(data.bets);
                    } else {
                        throw new Error(data.error || 'Failed to load recent bets');
                    }
                } catch (error) {
                    console.error('Error loading recent bets:', error);
                    recentBetsListEl.innerHTML = '<div class="no-bets-message">Failed to load recent bets</div>';
                }
            }

            function displayRecentBets(bets) {
                if (!bets || bets.length === 0) {
                    recentBetsListEl.innerHTML = '<div class="no-bets-message">No recent bets found</div>';
                    return;
                }

                recentBetsListEl.innerHTML = '';

                bets.forEach(bet => {
                    const betItem = document.createElement('div');
                    betItem.className = 'bet-item';

                    const colorDot = bet.color ? `<span class="color-dot ${bet.color}"></span>` : '';
                    const betTarget = bet.color ? `${colorDot}${bet.color.toUpperCase()}` : `Number ${bet.number}`;

                    let resultText = 'PENDING';
                    let resultClass = 'pending';

                    if (bet.round_ended && bet.round_result) {
                        if (bet.correct) {
                            resultText = 'WIN';
                            resultClass = 'win';
                        } else {
                            resultText = 'LOSS';
                            resultClass = 'loss';
                        }
                    }

                    const betDate = new Date(bet.created_at);
                    const timeAgo = getTimeAgo(betDate);

                    betItem.innerHTML = `
                        <div class="bet-info">
                            <div class="bet-round">Round ${bet.round_id || 'N/A'}</div>
                            <div class="bet-details">
                                ${betTarget} ‚Ä¢ ‚Çπ${bet.amount} ‚Ä¢ ${timeAgo}
                            </div>
                        </div>
                        <div class="bet-status">
                            <span class="bet-amount">‚Çπ${bet.amount}</span>
                            <span class="bet-result ${resultClass}">${resultText}</span>
                        </div>
                    `;

                    recentBetsListEl.appendChild(betItem);
                });
            }

            function getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${diffDays}d ago`;
            }

            function updateColorBetCount(color, increment) {
                const countElement = document.getElementById(`${color}-count`);
                if (countElement) {
                    const currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + increment;
                }
            }

            function clearRecentBets() {
                recentBetsListEl.innerHTML = '<div class="no-bets-message">No recent bets</div>';

                // Reset color bet counts
                ['red', 'green', 'violet'].forEach(color => {
                    const countElement = document.getElementById(`${color}-count`);
                    if (countElement) {
                        countElement.textContent = '0';
                    }
                });
            }

            function handleBettingClosed() {
                placeBetBtn.disabled = true;
                placeBetBtn.textContent = 'Betting Closed';

                // Hide timer and show calculating result loading state
                timerEl.style.display = 'none';
                resultLoadingEl.classList.remove('hidden');

                // Disable all betting interface
                colorBoxes.forEach(box => {
                    box.style.opacity = '0.5';
                    box.style.cursor = 'not-allowed';
                });

                addMessage('Betting is now closed! Calculating result...', 'result');
            }

            function handleRoundEnded(data) {
                // Hide loading skeleton and show actual result
                resultLoadingEl.classList.add('hidden');

                const resultColor = data.result_color;
                const resultNumber = data.result_number;
                resultDisplayEl.innerHTML = `
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">
                        <strong>Result: ${resultNumber}</strong>
                    </div>
                    <div style="font-size: 1.2rem; color: ${getColorCode(resultColor)};">
                        Color: ${resultColor.toUpperCase()}
                    </div>
                `;
                resultDisplayEl.className = 'result-display';

                // Find user's result
                const userResult = data.results.find(r => r.username === username);
                if (userResult) {
                    if (userResult.won) {
                        resultDisplayEl.classList.add('win');
                        resultDisplayEl.innerHTML += `<div style="margin-top: 10px; font-size: 1.3rem;">üéâ You Won ‚Çπ${userResult.payout}!</div>`;
                    } else {
                        resultDisplayEl.classList.add('lose');
                        resultDisplayEl.innerHTML += `<div style="margin-top: 10px; font-size: 1.1rem;">üòî You Lost!</div>`;
                    }
                    gameState.balance = userResult.new_balance;
                    balanceEl.textContent = userResult.new_balance;
                }

                resultDisplayEl.classList.remove('hidden');
                addMessage(`Round ended! Result: ${resultNumber} (${resultColor})`, 'result');
            }

            function getColorCode(color) {
                switch(color) {
                    case 'red': return '#dc2626';
                    case 'green': return '#059669';
                    case 'violet': return '#7c3aed';
                    default: return '#333';
                }
            }

            function handleNewRound() {
                // Reset game state for new round
                gameState.bettingClosed = false;
                gameState.currentPhase = 'betting';
                gameState.hasPlacedBet = false;

                resultDisplayEl.classList.add('hidden');
                resultLoadingEl.classList.add('hidden');
                timerEl.style.display = 'block'; // Show timer again for new round
                placeBetBtn.disabled = false;
                placeBetBtn.textContent = 'Place Bet';
                selectedColor = null;

                // Reset color boxes
                colorBoxes.forEach(box => {
                    box.classList.remove('selected');
                    box.style.opacity = '1';
                    box.style.cursor = 'pointer';
                });

                // Hide bet status info
                const betStatusInfo = document.getElementById('bet-status-info');
                betStatusInfo.classList.add('hidden');

                // Reset bet counts for new round
                ['red', 'green', 'violet'].forEach(color => {
                    const countElement = document.getElementById(`${color}-count`);
                    if (countElement) {
                        countElement.textContent = '0';
                    }
                });

                // Load recent bets to refresh the list
                loadRecentBets();

                addMessage('New round started! Place your bets now!', 'result');

                console.log('New round started - betting state reset');
            }

            function handleError(message) {
                // Check if it's a "one bet per round" error
                if (message.includes('one bet per round') || message.includes('only place one bet')) {
                    // Show special UI for one bet restriction
                    const betStatusInfo = document.getElementById('bet-status-info');
                    const statusText = betStatusInfo.querySelector('.status-text');
                    const statusIcon = betStatusInfo.querySelector('.status-icon');

                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = 'You can only place one bet per round. Wait for the next round.';
                    betStatusInfo.classList.remove('hidden');
                    betStatusInfo.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%)';
                    betStatusInfo.style.borderColor = '#f59e0b';

                    // Disable betting interface
                    placeBetBtn.disabled = true;
                    placeBetBtn.textContent = 'Bet Already Placed';

                    colorBoxes.forEach(box => {
                        box.style.opacity = '0.5';
                        box.style.cursor = 'not-allowed';
                    });

                    showNotification('You can only place one bet per round!', 'warning');
                } else {
                    // Handle other errors normally
                    addMessage(message, 'error');
                    showNotification(message, 'error');
                }
            }

            function updatePlayerCount(count) {
                playerCountEl.textContent = count;
            }

            function addMessage(message, type = '') {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}`;
                messageEl.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                messagesEl.appendChild(messageEl);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            // Event listeners
            colorBoxes.forEach(box => {
                box.addEventListener('click', () => {
                    if (gameState.bettingClosed || gameState.currentPhase === 'result') return;

                    colorBoxes.forEach(b => b.classList.remove('selected'));
                    box.classList.add('selected');
                    selectedColor = box.dataset.color;

                    if (selectedColor && !gameState.bettingClosed) {
                        placeBetBtn.disabled = false;
                    }
                });
            });

            placeBetBtn.addEventListener('click', () => {
                if (!selectedColor) {
                    showNotification('Please select a color first!', 'warning');
                    return;
                }

                const amount = parseInt(betAmountInput.value);

                // Check if user has zero balance
                if (gameState.balance <= 0) {
                    showNotification('üí∞ You need to deposit money before placing bets! Click "Add Money" to make a deposit.', 'error');
                    return;
                }

                if (amount <= 0 || amount > gameState.balance) {
                    showNotification('Invalid bet amount!', 'error');
                    return;
                }

                const betData = {
                    'type': 'place_bet',
                    'color': selectedColor,
                    'amount': amount,
                    'round_id': gameState.currentRound || 'unknown',
                    'timestamp': Date.now() / 1000  // Add timestamp for replay attack prevention
                };

                console.log('Current gameState:', gameState);
                console.log('Sending bet with data:', betData);

                if (!gameState.currentRound) {
                    console.error('No round_id available! gameState:', gameState);
                    showNotification('Game not ready, please wait...', 'warning');
                    return;
                }

                // Check if betting is still allowed (prevent stale state issues)
                if (gameState.bettingClosed || gameState.currentPhase === 'ended') {
                    console.warn('Betting appears to be closed based on local state. Phase:', gameState.currentPhase, 'Betting closed:', gameState.bettingClosed);
                    showNotification('Betting period has ended. Please wait for the next round.', 'warning');
                    return;
                }

                // Validate color on frontend
                const validColors = ['red', 'green', 'violet'];
                if (!validColors.includes(selectedColor)) {
                    console.error('Invalid color selected:', selectedColor);
                    showNotification(`Invalid color "${selectedColor}". Please select red, green, or violet.`, 'error');
                    return;
                }

                console.log('Placing bet - Current phase:', gameState.currentPhase, 'Time remaining:', gameState.timeRemaining);
                gameWebSocket.send(betData);
            });

            // Notification System
            function showNotification(message, type = 'info') {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;

                container.appendChild(notification);

                // Show notification
                setTimeout(() => notification.classList.add('show'), 100);

                // Hide and remove notification
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (container.contains(notification)) {
                            container.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // Timer stuck detection and recovery
            function checkTimerStuck() {
                const now = Date.now();
                const timeSinceUpdate = now - lastTimerUpdate;

                // If timer hasn't updated in 3 seconds and we're in betting phase
                if (timeSinceUpdate > 3000 && gameState.currentPhase === 'betting' && gameState.timeRemaining > 0) {
                    console.warn('Timer appears stuck, forcing result phase');

                    // Force transition to result phase
                    updateTimer({
                        time_remaining: 0,
                        phase: 'result'
                    });

                    showNotification('Timer sync issue detected, transitioning to results...', 'warning');
                }

                // If stuck at 1 second for more than 2 seconds
                if (gameState.timeRemaining === 1 && lastTimerValue === 1 && timeSinceUpdate > 2000) {
                    console.warn('Timer stuck at 1 second, forcing transition');

                    updateTimer({
                        time_remaining: 0,
                        phase: 'result'
                    });

                    showNotification('Timer issue resolved, showing results...', 'info');
                }

                lastTimerValue = gameState.timeRemaining;
            }

            // Check for stuck timer every second
            setInterval(checkTimerStuck, 1000);

            // Initialize
            addMessage(`Welcome ${username}! Connecting to game...`);

            // Load recent bets on page load
            loadRecentBets();

            // Cleanup on page unload to prevent memory leaks
            window.addEventListener('beforeunload', () => {
                if (gameWebSocket) {
                    gameWebSocket.destroy();
                }
            });

            window.addEventListener('pagehide', () => {
                if (gameWebSocket) {
                    gameWebSocket.destroy();
                }
            });
        } // End of initializeGame function
    </script>

    <!-- Optimized WebSocket Configuration -->
    {% if debug %}
    <script src="{% static 'js/websocket-config.js' %}"></script>
    {% else %}
    <script src="{% static 'js/websocket-config.min.js' %}"></script>
    {% endif %}
    <script src="{% static 'js/websocket-manager.js' %}"></script>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
</body>
</html>
