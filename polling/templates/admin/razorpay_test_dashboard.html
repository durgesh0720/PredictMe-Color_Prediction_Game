{% extends 'admin/modern_base.html' %}

{% block title %}Razorpay Test Dashboard - Admin Panel{% endblock %}

{% block extra_css %}
<style>
    .test-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
    }

    .test-warning {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        color: #92400e;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .test-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .test-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }

    .test-card h3 {
        color: #1e293b;
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }

    .test-info {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .test-button {
        background: #667eea;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin: 0.5rem;
        transition: background-color 0.2s;
    }

    .test-button:hover {
        background: #5a67d8;
    }

    .test-button.success {
        background: #10b981;
    }

    .test-button.danger {
        background: #ef4444;
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-test { background: #f59e0b; }
    .status-live { background: #10b981; }

    .code-block {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        overflow-x: auto;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-dashboard">
    <h1>üß™ Razorpay Test Dashboard</h1>
    <p>Monitor and test Razorpay integration in development mode</p>
</div>

<div class="test-warning">
    <strong>‚ö†Ô∏è Test Mode Active:</strong> You're currently using Razorpay test keys. Transactions won't appear in the live dashboard and no real money will be processed.
</div>

<div class="test-cards">
    <!-- Configuration Status -->
    <div class="test-card">
        <h3>üîß Configuration Status</h3>
        <div class="test-info">
            <p><span class="status-indicator {% if razorpay_mode == 'live' %}status-live{% else %}status-test{% endif %}"></span>
               Mode: <strong>{{ razorpay_mode|title }}</strong></p>
            <p>Key ID: <code>{{ razorpay_key_id|slice:":10" }}...</code></p>
            <p>Account: <code>{{ razorpay_account_number }}</code></p>
        </div>
        <button class="test-button" onclick="testConnection()">Test Connection</button>
    </div>

    <!-- Test Payments -->
    <div class="test-card">
        <h3>üí≥ Test Payments</h3>
        <div class="test-info">
            <p>Recent test payments: <strong>{{ test_payments_count }}</strong></p>
            <p>Total test amount: <strong>‚Çπ{{ test_payments_total }}</strong></p>
        </div>
        <button class="test-button success" onclick="createTestPayment()">Create Test Payment</button>
        <button class="test-button" onclick="viewTestPayments()">View All</button>
    </div>

    <!-- Test Withdrawals -->
    <div class="test-card">
        <h3>üí∞ Test Withdrawals</h3>
        <div class="test-info">
            <p>Pending withdrawals: <strong>{{ pending_withdrawals_count }}</strong></p>
            <p>Test withdrawals: <strong>{{ test_withdrawals_count }}</strong></p>
        </div>
        <button class="test-button success" onclick="createTestWithdrawal()">Create Test Withdrawal</button>
        <button class="test-button" onclick="viewTestWithdrawals()">View All</button>
    </div>
</div>

<!-- Test Credentials -->
<div class="test-card">
    <h3>üîë Test Credentials & Information</h3>
    
    <h4>Test Card Numbers (for testing payments):</h4>
    <div class="code-block">
Success: 4111 1111 1111 1111 (Visa)
Success: 5555 5555 5555 4444 (Mastercard)
Failure: 4000 0000 0000 0002 (Card declined)
CVV: Any 3 digits | Expiry: Any future date
    </div>

    <h4>Test Bank Account (for testing withdrawals):</h4>
    <div class="code-block">
Account Number: 123456789012
IFSC Code: SBIN0001234
Account Holder: Test User
Bank: State Bank of India
    </div>

    <h4>Webhook URL for testing:</h4>
    <div class="code-block">{{ webhook_url }}</div>
</div>

<!-- Live Mode Instructions -->
<div class="test-card">
    <h3>üöÄ Going Live</h3>
    <div class="test-info">
        <p><strong>To switch to live mode:</strong></p>
        <ol>
            <li>Complete KYC verification on Razorpay dashboard</li>
            <li>Get live API keys from Razorpay</li>
            <li>Update .env file with live keys</li>
            <li>Test thoroughly before going live</li>
        </ol>
    </div>
    <button class="test-button danger" onclick="showLiveInstructions()">Live Mode Guide</button>
</div>

<script>
function testConnection() {
    fetch('/control-panel/api/test-razorpay-connection/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Razorpay connection successful!\n\n' + data.message);
        } else {
            alert('‚ùå Connection failed:\n\n' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Error testing connection: ' + error.message);
    });
}

function createTestPayment() {
    const amount = prompt('Enter test payment amount (‚Çπ):', '100');
    if (amount && !isNaN(amount)) {
        window.open('/payment/dashboard/', '_blank');
    }
}

function createTestWithdrawal() {
    const amount = prompt('Enter test withdrawal amount (‚Çπ):', '50');
    if (amount && !isNaN(amount)) {
        window.open('/payment/dashboard/', '_blank');
    }
}

function viewTestPayments() {
    window.open('/control-panel/payments/transactions/', '_blank');
}

function viewTestWithdrawals() {
    window.open('/control-panel/withdrawals/', '_blank');
}

function showLiveInstructions() {
    alert(`üöÄ Going Live with Razorpay:

1. Complete Business Verification:
   - Submit business documents
   - Complete KYC process
   - Wait for approval (1-3 days)

2. Get Live API Keys:
   - Login to Razorpay Dashboard
   - Go to Settings > API Keys
   - Generate Live Mode keys

3. Update Configuration:
   - Replace test keys with live keys in .env
   - Update webhook URLs
   - Test in staging environment

4. Final Testing:
   - Test small amounts first
   - Verify webhook handling
   - Check bank account integration

5. Go Live:
   - Deploy to production
   - Monitor transactions
   - Set up alerts

Need help? Contact Razorpay support!`);
}

// Auto-refresh every 30 seconds
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}
